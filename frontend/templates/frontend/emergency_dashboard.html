{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergency Messages Dashboard - ResQMap</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'frontend/style.css' %}">
  <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}">

  <style>
    .status-pending { @apply bg-yellow-100 text-yellow-800; }
    .status-sent { @apply bg-green-100 text-green-800; }
    .status-failed { @apply bg-red-100 text-red-800; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- NAVBAR -->
  <nav class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <a href="{% url 'home' %}" class="flex items-center gap-3">
            <img src="{% static 'images/logo.png' %}" alt="logo" class="h-9 w-auto object-contain">
            <span class="font-bold text-gray-900 text-lg">ResQMap</span>
          </a>
        </div>

        <div class="flex items-center gap-3">
          <a href="{% url 'home' %}" class="px-4 py-2 text-gray-600 hover:text-gray-900">Home</a>
          <a href="{% url 'view_report' %}" class="px-4 py-2 text-gray-600 hover:text-gray-900">Reports</a>
          <a href="/admin/" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Admin Panel</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- HEADER -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">ðŸš¨ Emergency Messages Dashboard</h1>
      <p class="text-gray-600">Monitor and manage emergency SMS messages sent by users</p>
    </div>

    <!-- STATS CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex items-center">
          <div class="p-2 bg-blue-100 rounded-lg">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Total Messages</p>
            <p class="text-2xl font-bold text-gray-900" id="totalMessages">-</p>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex items-center">
          <div class="p-2 bg-green-100 rounded-lg">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Sent Successfully</p>
            <p class="text-2xl font-bold text-gray-900" id="sentMessages">-</p>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex items-center">
          <div class="p-2 bg-red-100 rounded-lg">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Failed</p>
            <p class="text-2xl font-bold text-gray-900" id="failedMessages">-</p>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex items-center">
          <div class="p-2 bg-yellow-100 rounded-lg">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Pending</p>
            <p class="text-2xl font-bold text-gray-900" id="pendingMessages">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
      <div class="flex flex-wrap gap-4 items-center">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
          <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Messages</option>
            <option value="sent">Sent</option>
            <option value="failed">Failed</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Search Phone</label>
          <input type="text" id="phoneSearch" placeholder="Search by phone number..." 
                 class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex-1"></div>
        <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
          ðŸ”„ Refresh
        </button>
      </div>
    </div>

    <!-- MESSAGES TABLE -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Emergency Messages</h3>
      </div>
      
      <div id="loadingIndicator" class="text-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
        <p class="text-gray-600">Loading emergency messages...</p>
      </div>

      <div id="messagesTable" class="hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacts</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="messagesTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Messages will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="noMessages" class="hidden text-center py-8">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p class="text-gray-500">No emergency messages found</p>
      </div>
    </div>

    <!-- PAGINATION -->
    <div id="pagination" class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-700">
        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalCount">0</span> messages
      </div>
      <div class="flex gap-2">
        <button id="prevBtn" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50" disabled>Previous</button>
        <button id="nextBtn" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50" disabled>Next</button>
      </div>
    </div>
  </main>

  <!-- MESSAGE DETAIL MODAL -->
  <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-900">Emergency Message Details</h2>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
          
          <div id="modalContent">
            <!-- Content will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 0;
    const pageSize = 20;
    let allMessages = [];
    let filteredMessages = [];

    // Load emergency messages
    async function loadMessages() {
      try {
          const response = await fetch('/api/emergency/messages/');
        const data = await response.json();
        allMessages = data.messages || [];
        applyFilters();
        updateStats();
      } catch (error) {
        console.error('Error loading messages:', error);
        showError('Failed to load emergency messages');
      }
    }

    // Apply filters
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const phoneSearch = document.getElementById('phoneSearch').value.toLowerCase();

      filteredMessages = allMessages.filter(msg => {
        const statusMatch = !statusFilter || msg.status === statusFilter;
        const phoneMatch = !phoneSearch || msg.user_phone.toLowerCase().includes(phoneSearch);
        return statusMatch && phoneMatch;
      });

      currentPage = 0;
      renderMessages();
    }

    // Update statistics
    function updateStats() {
      const total = allMessages.length;
      const sent = allMessages.filter(m => m.status === 'sent').length;
      const failed = allMessages.filter(m => m.status === 'failed').length;
      const pending = allMessages.filter(m => m.status === 'pending').length;

      document.getElementById('totalMessages').textContent = total;
      document.getElementById('sentMessages').textContent = sent;
      document.getElementById('failedMessages').textContent = failed;
      document.getElementById('pendingMessages').textContent = pending;
    }

    // Render messages table
    function renderMessages() {
      const start = currentPage * pageSize;
      const end = start + pageSize;
      const pageMessages = filteredMessages.slice(start, end);

      const tbody = document.getElementById('messagesTableBody');
      tbody.innerHTML = '';

      if (pageMessages.length === 0) {
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('messagesTable').classList.add('hidden');
        document.getElementById('noMessages').classList.remove('hidden');
        return;
      }

      document.getElementById('loadingIndicator').classList.add('hidden');
      document.getElementById('messagesTable').classList.remove('hidden');
      document.getElementById('noMessages').classList.add('hidden');

      pageMessages.forEach(msg => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${new Date(msg.created_at).toLocaleString()}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
            ${msg.user_phone}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
            ${msg.message}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full status-${msg.status}">
              ${msg.status.toUpperCase()}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${msg.contacts_notified.length} contacts
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${msg.lat && msg.lng ? `${msg.lat.toFixed(4)}, ${msg.lng.toFixed(4)}` : 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button onclick="showMessageDetails(${msg.id})" class="text-blue-600 hover:text-blue-900">
              View Details
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Update pagination
      updatePagination();
    }

    // Update pagination controls
    function updatePagination() {
      const total = filteredMessages.length;
      const start = currentPage * pageSize + 1;
      const end = Math.min((currentPage + 1) * pageSize, total);

      document.getElementById('showingStart').textContent = total > 0 ? start : 0;
      document.getElementById('showingEnd').textContent = end;
      document.getElementById('totalCount').textContent = total;

      document.getElementById('prevBtn').disabled = currentPage === 0;
      document.getElementById('nextBtn').disabled = end >= total;
    }

    // Show message details modal
    function showMessageDetails(messageId) {
      const message = allMessages.find(m => m.id === messageId);
      if (!message) return;

      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Phone Number</label>
            <p class="mt-1 text-sm text-gray-900 font-mono">${message.user_phone}</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Message</label>
            <p class="mt-1 text-sm text-gray-900 whitespace-pre-wrap">${message.message}</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Status</label>
            <span class="mt-1 inline-flex px-2 py-1 text-xs font-semibold rounded-full status-${message.status}">
              ${message.status.toUpperCase()}
            </span>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Location</label>
            <p class="mt-1 text-sm text-gray-900">
              ${message.lat && message.lng ? `${message.lat}, ${message.lng}` : 'Not provided'}
            </p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Contacts Notified</label>
            <div class="mt-1 space-y-2">
              ${message.contacts_notified.map(contact => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                  <div>
                    <p class="text-sm font-medium text-gray-900">${contact.name}</p>
                    <p class="text-xs text-gray-500">${contact.organization || 'No organization'}</p>
                  </div>
                  <p class="text-sm text-gray-600 font-mono">${contact.phone_number}</p>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Timestamp</label>
            <p class="mt-1 text-sm text-gray-900">${new Date(message.created_at).toLocaleString()}</p>
          </div>
        </div>
      `;

      document.getElementById('messageModal').classList.remove('hidden');
    }

    // Event listeners
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('phoneSearch').addEventListener('input', applyFilters);
    document.getElementById('refreshBtn').addEventListener('click', loadMessages);
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        renderMessages();
      }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      const total = filteredMessages.length;
      if ((currentPage + 1) * pageSize < total) {
        currentPage++;
        renderMessages();
      }
    });
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('messageModal').classList.add('hidden');
    });

    // Load messages on page load
    loadMessages();
  </script>
</body>
</html>
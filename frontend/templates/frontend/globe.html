<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <title>Disaster Management Globe ‚Äî Bhuvan 3D</title>
  <style>
    #cesiumContainer { width: 100%; height: 100%; }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  
  <!-- Navbar -->
  <nav class="w-full flex justify-between items-center px-6 py-4 bg-black shadow-md sticky top-0 z-10">
    <h1 class="text-2xl font-bold">üåç Disaster Management ‚Äî Bhuvan 3D Globe</h1>
    <a href="{% url 'home' %}">
      <button class="px-5 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl hover:opacity-90 transition shadow-lg">
        Go To Home
      </button>
    </a>
  </nav>

  <div class="flex h-[calc(100vh-64px)]">
    <!-- Cesium Globe -->
    <div class="w-[75%] h-full rounded-r-2xl overflow-hidden shadow-lg border border-gray-700">
      <div id="cesiumContainer"></div>
    </div>

    <!-- Sidebar -->
    <div class="w-[25%] h-full bg-black p-6 flex flex-col rounded-l-2xl shadow-lg border-l border-gray-700">
      <h2 class="text-3xl font-bold mb-6 border-b border-gray-600 pb-2">Layers / Actions</h2>

      <!-- Layer Controls -->
      <div class="space-y-4 flex-1">
        <label class="flex items-center gap-3">
          <input type="checkbox" id="bhuvanLayer" class="w-5 h-5 accent-blue-500">
          <span>Bhuvan Satellite Layer</span>
        </label>
        <label class="flex items-center gap-3">
          <input type="checkbox" id="weatherLayer" class="w-5 h-5 accent-green-500">
          <span>Weather Overlay</span>
        </label>
        <label class="flex items-center gap-3">
          <input type="checkbox" id="disasterReports" class="w-5 h-5 accent-yellow-500">
          <span>Disaster Reports</span>
        </label>
        <label class="flex items-center gap-3">
          <input type="checkbox" id="rescueHotspots" class="w-5 h-5 accent-red-500">
          <span>Rescue Hotspots</span>
        </label>
        <label class="flex items-center gap-3">
          <input type="checkbox" id="heatmapToggle" class="w-5 h-5 accent-purple-500">
          <span>ML Heatmap</span>
        </label>
      </div>

      <!-- Earthquake Map Button -->
      <div class="mt-6 border-t border-gray-700 pt-4">
        <a href="{% url 'disaster_map' %}">
          <button class="w-full px-5 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-md">
            üåê View Earthquake Map
          </button>
        </a>
      </div>
    </div>
  </div>

  <!-- Cesium Script -->
  <script type="module">
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0NGJjY2U0ZC0zMThmLTQwYmYtOWZmNS05ZDczMmM5OGMzNDciLCJpZCI6MzM2NTM5LCJpYXQiOjE3NTY0Njc4MTJ9.0fikg7ZsmBpEWcpu1gAb62kGQALk_9GZJxXsPFpzAQ8";

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      timeline: false,
      fullscreenButton: false,
      homeButton: true,
      sceneModePicker: true,
      baseLayerPicker: true,
    });

    // Initial camera
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(78.9629, 22.5937, 2500000),
    });

    // ====== Bhuvan Layers with TOKEN ======
    const BHUVAN_TOKEN = "422c3bc4e365a753a8db8f0c259d43bfe9d9f7c6";

    // Satellite / India3 WMS
    const bhuvanProvider = new Cesium.WebMapServiceImageryProvider({
      url: "https://bhuvan-iserver.nrsc.gov.in/bhuvan/wms",
      layers: "india3",
      parameters: {
        service: "WMS",
        version: "1.1.1",
        request: "GetMap",
        format: "image/png",
        transparent: "true",
        token: BHUVAN_TOKEN,
      },
    });
    const bhuvanLayer = viewer.imageryLayers.addImageryProvider(bhuvanProvider);
    bhuvanLayer.show = false;

    document.getElementById("bhuvanLayer").addEventListener("change", (e) => {
      bhuvanLayer.show = e.target.checked;
    });

    // Flood Hazard Layer
    const floodProvider = new Cesium.WebMapServiceImageryProvider({
      url: "https://bhuvan-ras2.nrsc.gov.in/cgi-bin/hazard.exe",
      layers: "hazard",
      parameters: {
        service: "WMS",
        version: "1.1.1",
        request: "GetMap",
        format: "image/png",
        transparent: "true",
        token: BHUVAN_TOKEN,
      },
    });
    const floodLayer = viewer.imageryLayers.addImageryProvider(floodProvider);
    floodLayer.show = false;

    document.getElementById("disasterReports").addEventListener("change", (e) => {
      floodLayer.show = e.target.checked;
    });

    // Weather Layer (placeholder, confirm exact WMS layer name)
    const weatherProvider = new Cesium.WebMapServiceImageryProvider({
      url: "https://bhuvan-app1.nrsc.gov.in/2dresources/bhuvanstore2.php",
      layers: "cloud_cover_insat3ds", // replace with correct name from GetCapabilities
      parameters: {
        service: "WMS",
        version: "1.1.1",
        request: "GetMap",
        format: "image/png",
        transparent: "true",
        token: BHUVAN_TOKEN,
      },
    });
    const weatherLayer = viewer.imageryLayers.addImageryProvider(weatherProvider);
    weatherLayer.show = false;

    document.getElementById("weatherLayer").addEventListener("change", (e) => {
      weatherLayer.show = e.target.checked;
    });

    // Rescue Hotspots
    document.getElementById("rescueHotspots").addEventListener("change", (e) => {
      if (e.target.checked) {
        viewer.entities.add({
          name: "Rescue Hotspot",
          position: Cesium.Cartesian3.fromDegrees(77.5946, 12.9716),
          point: { pixelSize: 14, color: Cesium.Color.CYAN },
        });
      } else {
        viewer.entities.removeAll();
      }
    });
  </script>
</body>
</html>
